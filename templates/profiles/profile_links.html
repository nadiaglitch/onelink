{% extends "base.html" %}
{% load static %}
{% block content %}
<!-- Reusable inline SVG sprite -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute; width:0; height:0; overflow:hidden;">
  <symbol id="icon-pencil" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.33h-.84v-.84l9.02-9.02.84.84-9.02 9.02zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
  </symbol>
</svg>

{# Real form so non-JS fallback still works #}
<form class="profile-shell"
      action=""
      method="post"
      enctype="multipart/form-data"
      x-data="profileLinksEditor()"
      x-init="init()">
  {% csrf_token %}

  <!-- Avatar (full width shell but visually centered) -->
  <div class="avatar-wrap">
    <img
      id="avatarPreview"
      alt="Avatar"
      src="{% if profile.profile_image %}{{ profile.profile_image.url }}{% else %}{% static 'images/logo.png' %}{% endif %}"
      class="avatar"
    >
    <input type="file" name="profile_image" accept="image/*" @change="previewAvatar">
    <span class="avatar-edit-badge" aria-hidden="true" title="Change avatar">
      <svg><use href="#icon-pencil"/></svg>
    </span>
  </div>

  <!-- Display name (uniform width) -->
  <div class="editor-row">
    <h1 class="editor-title">
      <span class="editable-wrap editable-surface editor-surface">
        <input
          class="editable-text"
          type="text"
          name="display_name"
          value="{{ profile.display_name }}"
          placeholder="Your name"
          @blur="saveProfile" />
        <svg class="edit-icon" aria-hidden="true"><use href="#icon-pencil"/></svg>
      </span>
    </h1>
  </div>

  <!-- Handle (uniform width, '@' inside the surface) -->
  <div class="editor-row">
    <div class="editable-wrap editable-surface editor-surface">
      <span class="prefix-at" aria-hidden="true">@</span>
      <input
        class="editable-text"
        type="text"
        name="handle"
        value="{{ profile.handle }}"
        placeholder="username"
        inputmode="latin" autocomplete="off" autocapitalize="none" spellcheck="false" maxlength="15"
        @input="onHandleInput($event)"
        @blur="saveProfile" />
      <svg class="edit-icon" aria-hidden="true"><use href="#icon-pencil"/></svg>
    </div>
    <p x-text="errors.handle" x-show="errors.handle" class="text-red-500 text-sm text-center mt-1" aria-live="polite"></p>
  </div>

  <!-- Bio (uniform width, icon inside the same surface) -->
  <div class="editor-row">
    <div class="editable-wrap editable-surface editor-surface editor-bio">
      <div
        class="bio editable-area"
        name="bio"
        contenteditable="true"
        data-placeholder="Write your bio here"
        x-ref="bio"
        @input="updateBioPlaceholder"
        @blur="saveProfile"
      >{{ profile.bio|default_if_none:'' }}</div>
      <svg class="edit-icon" aria-hidden="true"><use href="#icon-pencil"/></svg>
    </div>
  </div>

  <!-- Links list (uniform width) -->
  <div class="editor-row">
    <div class="links" id="linksList">
      {% if formset.management_form %}{{ formset.management_form }}{% endif %}
      {% for f in formset %}
        {% with pk=f.instance.pk title_val=f.instance.title url_val=f.instance.url %}
        <div class="link-card" data-id="{{ pk }}">
          <div class="link-guts">
            <input
              class="editable-text link-title"
              type="text"
              value="{{ title_val|default:url_val }}"
              placeholder="Display title"
              data-field="title"
              data-original="{{ title_val|default:url_val }}"
              @blur="onLinkFieldBlur($event)">
            <input
              class="editable-text link-url"
              type="url"
              value="{{ url_val }}"
              placeholder="https://example.com"
              data-field="url"
              data-original="{{ url_val }}"
              @blur="onLinkFieldBlur($event)">
            <small class="muted hidden" data-edited-pill>Edited</small>
          </div>
          <div class="link-actions">
            <button type="button" class="icon-btn" @click="deleteLink($event)" title="Delete" {% if not pk %}disabled{% endif %}>Delete</button>
          </div>
        </div>
        {% endwith %}
      {% empty %}
        <p>No links yet â€” add your first one below.</p>
      {% endfor %}
    </div>

    <!-- Add new link -->
    <div class="link-card" style="margin-top: 10px;">
      <div class="link-guts">
        <input class="editable-text link-title" type="text" placeholder="Display title" id="newTitle">
        <input class="editable-text link-url" type="url" placeholder="https://example.com" id="newUrl">
      </div>
      <div class="link-actions">
        <button type="button" class="icon-btn" @click="createLink">Add</button>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}