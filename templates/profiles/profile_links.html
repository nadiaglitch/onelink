{% extends "base.html" %}
{% load static %}
{% block content %}
<!-- Reusable inline SVG sprite -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute; width:0; height:0; overflow:hidden;">
  <symbol id="icon-pencil" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.33h-.84v-.84l9.02-9.02.84.84-9.02 9.02zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
  </symbol>
</svg>

<!-- Real form so non-JS fallback still works -->
<form class="profile-shell"
      action=""
      method="post"
      enctype="multipart/form-data"
      x-data="profileLinksEditor()"
      x-init="init()"
      novalidate>
  {% csrf_token %}

  <!-- Avatar -->
  <div class="avatar-wrap">
    <img
      id="avatarPreview"
      alt="Avatar"
      src="{% if profile.profile_image %}{{ profile.profile_image.url }}{% else %}{% static 'images/logo.png' %}{% endif %}"
      class="avatar"
    >
    <input type="file" name="profile_image" accept="image/*" @change="previewAvatar">
    <span class="avatar-edit-badge" aria-hidden="true" title="Change avatar">
      <svg><use href="#icon-pencil"/></svg>
    </span>
  </div>

  <!-- Display name -->
  <div class="editor-row">
    <h1 class="editor-title">
      <span class="editable-wrap editable-surface editor-surface">
        <input
          class="editable-text"
          type="text"
          name="display_name"
          value="{{ profile.display_name }}"
          placeholder="Your name"
          @blur="saveProfile" />
        <svg class="edit-icon" aria-hidden="true"><use href="#icon-pencil"/></svg>
      </span>
    </h1>
  </div>

  <!-- Handle -->
  <div class="editor-row">
    <div class="editable-wrap editable-surface editor-surface">
      <span class="prefix-at" aria-hidden="true">@</span>
      <input
        class="editable-text"
        type="text"
        name="handle"
        value="{{ profile.handle }}"
        placeholder="username"
        inputmode="latin" autocomplete="off" autocapitalize="none" spellcheck="false" maxlength="15"
        @input="onHandleInput($event)"
        @blur="saveProfile" />
      <svg class="edit-icon" aria-hidden="true"><use href="#icon-pencil"/></svg>
    </div>
    <p x-text="errors.handle" x-show="errors.handle" class="text-red-500 text-sm text-center mt-1" aria-live="polite"></p>
  </div>

  <!-- Bio -->
  <div class="editor-row">
    <div class="editable-wrap editable-surface editor-surface editor-bio">
      <div
        class="bio editable-area"
        contenteditable="true"
        data-placeholder="Write your bio here"
        x-ref="bioEditable"
        @input="updateBioPlaceholder"
        @blur="saveProfile"
        x-init="$nextTick(() => { 
          const t = ($refs.bioEditable.textContent || '').trim();
          $refs.bioEditable.dataset.empty = String(t.length === 0);
        })"
      >{{ profile.bio|default_if_none:'' }}</div>

      <!-- Hidden field that actually submits to Django -->
      <textarea name="bio" x-ref="bioField" class="hidden" aria-hidden="true"></textarea>

      <svg class="edit-icon" aria-hidden="true"><use href="#icon-pencil"/></svg>
    </div>
  </div>

  <!-- Links list -->
  <div class="editor-row">
    <div class="links" id="linksList" data-formset-container>
      {{ formset.management_form }}

      {% for f in formset.forms %}
        {% with idx=forloop.counter0 %}
        <div class="link-card" data-form-row data-form-index="{{ idx }}" data-id="{{ f.instance.pk|default_if_none:'' }}">
          <!-- Required hidden fields so Django can map updates -->
          {{ f.id }}
          <div class="sr-only">
            {{ f.ORDER }}
            {{ f.DELETE }}
          </div>

          <div class="link-guts">
            <div class="field-wrap">
              {{ f.title }}
              {% if f.title.errors %}
                <small class="text-red-500">{{ f.title.errors|join:", " }}</small>
              {% endif %}
            </div>

            <div class="field-wrap">
              {{ f.url }}
              {% if f.url.errors %}
                <small class="text-red-500">{{ f.url.errors|join:", " }}</small>
              {% endif %}
            </div>

            <small class="muted hidden" data-edited-pill>Edited</small>
          </div>

          <div class="link-actions">
            {% if f.instance.pk %}
              <!-- Saved row -> show Delete -->
              <button
                type="button"
                class="icon-btn"
                title="Delete"
                @click="deleteLink($event)"
              >
                <span>Delete</span>
              </button>
            {% else %}
              <!-- Blank/unsaved row -> show Add link -->
              <button
                type="button"
                class="icon-btn"
                title="Add link"
                @click="addLink()"
              > +  Add</button>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% empty %}
        <p>No links yet â€” start by filling the blank row below.</p>
      {% endfor %}
    </div>

    <!-- Template for dynamically added rows (Django's __prefix__ placeholders). -->
    <template id="empty-form-template">
      <div class="link-card" data-form-row data-id="">
        {{ formset.empty_form.id }}
        <div class="sr-only">
          {{ formset.empty_form.ORDER }}
          {{ formset.empty_form.DELETE }}
        </div>

        <div class="link-guts">
          <div class="field-wrap">
            {{ formset.empty_form.title }}
          </div>
          <div class="field-wrap">
            {{ formset.empty_form.url }}
          </div>
          <small class="muted hidden" data-edited-pill>Edited</small>
        </div>

        <div class="link-actions">
          <button
            type="button"
            class="icon-btn"
            title="Add link"
            @click="addLink()"
          >Add link</button>
        </div>
      </div>
    </template>
  </div>

</form>

<!-- Alpine (defer) -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}